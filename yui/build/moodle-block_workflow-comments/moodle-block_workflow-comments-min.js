YUI.add("moodle-block_workflow-comments",function(c,e){var o="/blocks/workflow/ajax.php",l="stateid",r="editorid",t="editorname",n="block_workflow",i="block_workflow_comments",u="block_workflow_editcommentbutton",m="block_workflow_finishstepbutton",a="block-workflow-panel",f="content",g="loading-lightbox",d="wfk-submit",w="hidden",h=new M.core.dialogue({headerContent:"",bodyContent:c.one("."+a),visible:!1,modal:!0,width:"auto",zIndex:100}),s=function(){s.superclass.constructor.apply(this,arguments)};c.extend(s,c.Base,{_formSubmitEvent:null,_escCloseEvent:null,_closeButtonEvent:null,_loadingNode:null,initializer:function(){h.hide();var e=c.one("."+a);e&&(this._loadingNode=e.one("."+g),this.attachEvents())},show:function(s,e){var i,t;s.halt(),e?(h.set("headerContent",M.str.block_workflow.finishstep),c.one("."+a).one("."+d+" input").set("value",M.str.block_workflow.finishstep),this._formSubmitEvent=c.one("."+d+" input").on("click",this.finishstep,this)):(h.set("headerContent",M.str.block_workflow.editcomments),c.one("."+a).one("."+d+" input").set("value",M.str.moodle.savechanges),this._formSubmitEvent=c.one("."+d+" input").on("click",this.save,this)),h.show(),this._escCloseEvent=c.on("key",this.hide,document.body,"down:27",this),c.Event.purgeElement(c.one(".moodle-dialogue-hd .closebutton"),!0),this._closeButtonEvent=c.on("click",this.hide,c.one(".moodle-dialogue-hd .closebutton"),this),e={sesskey:M.cfg.sesskey,action:"getcomment",stateid:this.get(l)},"undefined"!=typeof tinyMCE&&(i=tinyMCE.get(this.get(r)),t=tinymce.DOM.get(this.get(r)+"_ifr"),30===(t=tinymce.DOM.getSize(t)).h&&i.theme.resizeTo(t.w,90)),c.io(M.cfg.wwwroot+o,{method:"POST",data:build_querystring(e),on:{start:this.displayLoading,complete:function(e,t){var o,n;try{if((o=c.JSON.parse(t.responseText)).error)return new M.core.ajaxException(o)}catch(s){new M.core.exception(s)}"undefined"!=typeof tinyMCE?i.setContent(o.response.comment):(t=this.get(r),(n=c.one(document.getElementById(t+"editable")))&&n.setHTML(o.response.comment),c.one(document.getElementById(t)).set("value",o.response.comment))},end:this.removeLoading},context:this})},hide:function(){h.hide(),this._escCloseEvent&&(this._escCloseEvent.detach(),this._escCloseEvent=null),this._closeButtonEvent&&(this._closeButtonEvent.detach(),this._closeButtonEvent=null),this._formSubmitEvent&&(this._formSubmitEvent.detach(),this._formSubmitEvent=null)},save:function(){var e="undefined"!=typeof tinyMCE?tinyMCE.get(this.get(r)).getContent():c.one(document.getElementById(this.get(r))).get("value"),s=c.one("."+n+" ."+i),e={sesskey:M.cfg.sesskey,action:"savecomment",stateid:this.get(l),text:e,format:document.getElementsByName(this.get(t)+"[format]")[0].value};c.io(M.cfg.wwwroot+o,{method:"POST",data:build_querystring(e),on:{start:this.displayLoading,complete:function(e,t){var o;try{if((o=c.JSON.parse(t.responseText)).error)return new M.core.ajaxException(o)}catch(n){new M.core.exception(n)}o.response.blockcomments?s.setContent(o.response.blockcomments):s.setContent(M.str.block_workflow.nocomments)},end:this.removeLoading},context:this}),this.hide()},finishstep:function(){var e="undefined"!=typeof tinyMCE?tinyMCE.get(this.get(r)).getContent():c.one(document.getElementById(this.get(r))).get("value"),i=c.one("."+n+" ."+f),e={sesskey:M.cfg.sesskey,action:"finishstep",stateid:this.get(l),text:e,format:document.getElementsByName(this.get(t)+"[format]")[0].value};c.io(M.cfg.wwwroot+o,{method:"POST",data:build_querystring(e),on:{start:this.displayLoading,complete:function(e,t){var o,n;try{if((o=c.JSON.parse(t.responseText)).error)return new M.core.ajaxException(o)}catch(s){new M.core.exception(s)}o.response.blockcontent&&(i.setContent(o.response.blockcontent),o.response.stateid&&(this.set(l,o.response.stateid),this.attachEvents(),M.blocks_workflow.init_todolist({stateid:o.response.stateid})),o.response.listworkflows&&(n=i.one(".singleselect form select").getAttribute("id"),require(["jquery"],function(e){e("#"+n).change(function(){typeof e(this).find(":selected").attr("data-ignore")==typeof undefined&&e("#"+n).closest("form").submit()})})))},end:this.removeLoading},context:this}),this.hide()},displayLoading:function(){this._loadingNode.removeClass(w)},removeLoading:function(){this._loadingNode.addClass(w)},attachEvents:function(){var e=c.one("."+u+" button, ."+u+" input[type=submit]");e&&e.on("click",this.show,this,!1),(e=c.one("."+m+" button, ."+m+" input[type=submit]"))&&e.on("click",this.show,this,!0)}},{NAME:"blocks_workflow_comments",ATTRS:{stateid:{value:null},editorid:{value:null},editorname:{validator:c.Lang.isString,value:null}}}),M.blocks_workflow=M.blocks_workflow||{},M.blocks_workflow.init_comments=function(e){return new s(e)}},"@VERSION@",{requires:["base","overlay","moodle-core-formautosubmit","moodle-core-notification"]});